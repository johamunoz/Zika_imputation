---
title: "Plausibility bounds"
output: pdf_document
---

```{r echo=FALSE, results='hide',message=FALSE}
rm(list=ls()) # clean environment

# Data manipulation packages
library(here) 
library(data.table)
library(dplyr)
require(knitr)
```


```{r echo=FALSE, results='hide',message=FALSE}
data <- as.data.table(read.csv(here('1_Input_data','pilot10_08SEP21_withmetadata.csv'), stringsAsFactors=FALSE, fileEncoding="latin1"))
infoexp <- as.data.table(readxl::read_xlsx(here('1_Input_data','Infoexp.xlsx'),sheet="Table")) #CSV file with the

base.dir <- dirname(dirname(rstudioapi::getActiveDocumentContext()$path)) # set main base working directory
setwd(base.dir)

data<-as.data.table(read.csv('1_Input_data/pilot10_08SEP21_withmetadata.csv', stringsAsFactors=FALSE, fileEncoding="latin1"))

infoexp<-as.data.table(readxl::read_xlsx("1_Input_data/Infoexp.xlsx",sheet="Table")) #Table were are specified the included variables according Expert opinion, also the includes the order in which variables are imputed 
var_inc<-infoexp[Inclusion==1,Variable] #Variables to work with
data<-as.data.table(data[,..var_inc]) #Filter dataset

#1. Initial clean up the dataset -----
#1.0. Check for duplicates ----
data[,comb:=paste0(studyname,mid_original,sep="_")] #create a variable that combine study and patient id
n_occur <- data.table(table(data$comb))
#n_occur[n_occur$N>1] #check visually which observations are duplicated
var1<-n_occur[n_occur$N > 1&V1!='_Spain_Soriano'& V1!='_TrinidadTobago_Sohan']$V1 
var1<-n_occur[n_occur$N > 1]$V1
Duplicates<-data[comb%in%var1&multiplegest!=1] # table to report to harmonization team.
write.csv(Duplicates,file='5_Internal_support/Possible_duplicates.csv')

# 1.1. Check format of categorical variables----
char <-   which(sapply(data, is.character)) #which are char
datac<-data[,..char]
summary(datac)
unique(datac$inf_head_circ_age_fu1)
data[,inf_head_circ_age_fu1:=as.numeric(sub(" .*", "",data$inf_head_circ_age_fu1))] # remove years
data[,zikv_elisa_ga_1:=as.numeric(sub(" .*", "",data$zikv_elisa_ga_1))] #remove weeks

#unique(data$othabnorm_spec) # 39 categories ask if really want to include this
#data[,othabnorm_spec:=NULL] # We temporal remove it from dataset as it is messy
data[zikv_pcr_date_1%in%c("22027","888",""), zikv_pcr_date_1:=NA]
data[zikv_elisa_date_1%in%c(""),zikv_elisa_date_1:=NA]
data[symp_date%in%c(""),symp_date:=NA]
data[,arb_clindiag:=ifelse(arb_clindiag==777,6,arb_clindiag)] # We set the NA value ("777") to a level "6" because we later use it for define CZS variable

#1.1. Set to NA : 666,777,888,999 values----
data[data==""] <-NA
data[data==666] <-  NA
data[data==777] <-  NA
data[data==888] <-  NA
data[data==999] <-  NA
data[data==9999] <-  NA

data[,Comb_id:=paste(studyname,mid_original,childid_original,sep="-")] #combinated ID from study mother and child id
```

Under this document we describe the plausible values consider for each of the variables used in the imputation model. In addition we provide the rules that we applied on the creation of additional variables required for the imputation model.

## Plausibility bounds 
The following table describes the plausibility bounds for the continuous variables and the time-related variables used in the imputation process. There you can see for each variable, the classification, the units and the plausibility bounds (minimum, maximum). We set all values outside the plausible bounds as NA.
```{r functions,echo=F}
Boundaries<-infoexp[Inclusion==1&Vtype%in%c("C","T"),c("Type","Variable","Vtype","Units","Min","Max")]
Boundaries[,Vtype:=ifelse(Vtype=="C","Continuous","Time")]
Boundaries[,Max:=ifelse(is.na(Max),"Inf",Max)]
knitr::kable(Boundaries, 
             col.names = c("Classification",
                           "Variable name",
                           "Variable type",
                           "Units",
                           "Min",
                           "Max"))

```

By running this code, it is automatically generated the "obs_to_check.RData" file with the observations outside the plausibility range, it can be found in the "3_Output_data" folder. Inside obs_to_check dataset, there is an additional column called "Var_to_check" that indicates the variable with implausible values for each observation.

```{r,echo=FALSE}
boundvar=Boundaries$Variable
obs_to_check<-NULL
for(var in boundvar){
  data$var_bound<-data[,..var]
  data$Var_to_check<-var
  Min=as.numeric(Boundaries[Variable==var]$Min)
  Max=as.numeric(ifelse(is.na(Boundaries[Variable==var]$Max),1/0,Boundaries[Variable==var]$Max))
  data_out<-data[var_bound<=Min|var_bound>=Max]
  obs_to_check<-rbind(obs_to_check,data_out)
}    

save(obs_to_check,file=here('3_Output_data','obs_to_check.RData'))
```


## Logic rules for exposures

# Set to NA values
SAS and R manage differently the NA values, to easy the imputation process we set to NA all the values with values equal to 666,777,888,999. Except for the arb_clindiag varaible, which "777" values were reasigned to a  "6" level as it is used later on to define the CZS variable.

# Zika test time of measurement (zikv_ga)
In case that is not specified the zikv_ga value for an observation, for which it was specified the time of measurement for the PCR "zikv_pcr_ga_1" or the elisa test "zikv_elisa_ga_1", we set the zikv_ga value with the date of measurment of the earliest test. 

if is.na (zikv_ga) then zikv_ga = min (zikv_pcr_ga_1,zikv_elisa_ga_1)


# storch_patho

# arb_ever

# flavi_alpha_virus

# arb_preg_nz



